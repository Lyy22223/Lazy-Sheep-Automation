# 传智播客答题脚本功能说明

## 脚本信息
- **名称**: 传智播客答题脚本
- **版本**: 2.1.0
- **作者**: 懒羊羊
- **描述**: 自动填写单选题、多选题、判断题、填空题和简答题，支持AI答题和答题过程记录

---

## 模块结构

### 1. 工具函数模块 (utils)

| 函数名 | 用途 |
|--------|------|
| `sleep(ms)` | 延迟函数，返回Promise，用于异步等待 |
| `log(...args)` | 日志输出函数，同时输出到控制台和UI日志面板 |
| `getQuestionId(element)` | 从DOM元素中提取题目ID（data-id属性） |
| `getQuestionText(element)` | 从DOM元素中提取题目文本内容 |
| `isQuestionAnswered(questionItem)` | 检查题目是否已经作答（通过检查选项状态） |
| `extractAnswerFromSolution(solution, questionType)` | 从solution字段中提取答案（支持多种格式） |
| `cleanMarkdownCodeBlocks(text)` | 清理文本中的Markdown代码块标记（```） |

---

### 2. 答题记录管理器 (answerRecordManager)

| 函数名 | 用途 |
|--------|------|
| `initFromAnswerDB()` | 从答案数据库初始化答题记录 |
| `updateRecord(questionId, answer, questionContent, questionType)` | 更新或创建答题记录 |
| `saveToStorage()` | 保存答题记录到浏览器本地存储 |
| `loadFromStorage()` | 从浏览器本地存储加载答题记录 |
| `clear()` | 清空所有答题记录 |
| `export(format)` | 导出答题记录（支持JSON、TXT、CSV格式） |
| `updateUI()` | 更新答题记录UI显示 |
| `importAnswers(jsonData)` | 从JSON数据导入答案到答案库 |

---

### 3. 答案数据库管理器 (answerDBManager)

| 函数名 | 用途 |
|--------|------|
| `loadFromJSON(jsonData)` | 从JSON数据加载答案数据库（支持index.json和fasfa.json格式） |
| `loadFromStorage()` | 从浏览器本地存储加载答案数据库 |
| `saveToStorage()` | 保存答案数据库到浏览器本地存储 |
| `getAnswer(questionId)` | 根据题目ID获取答案（支持ID映射） |
| `deduplicateByContent()` | 根据题目内容去重，删除重复题目 |
| `analyzeSolutionsWithAI()` | 使用AI批量分析solution字段提取答案 |
| `analyzeQuestionsFromJSONWithAI(jsonData)` | 使用AI分析JSON数据中的题目，提取答案 |

---

### 4. 答题控制器 (answerController)

| 函数名 | 用途 |
|--------|------|
| `answerDanxuan(questionItem)` | 自动回答单选题 |
| `answerDuoxuan(questionItem)` | 自动回答多选题 |
| `answerPanduan(questionItem)` | 自动回答判断题 |
| `answerTiankong(questionItem)` | 自动回答填空题 |
| `answerJianda(questionItem)` | 自动回答简答题（支持富文本编辑器） |
| `autoAnswer()` | 自动答题主函数，遍历所有题目类型并自动答题 |

---

### 5. 控制面板 (controlPanel)

| 函数名 | 用途 |
|--------|------|
| `create()` | 创建控制面板UI（包含控制、AI答题、答题记录三个标签页） |
| `switchTab(tabName)` | 切换标签页 |
| `makeDraggable(element)` | 使控制面板可拖拽 |
| `updateAnswerCount()` | 更新答案库题目数量显示 |
| `updateStatus(text)` | 更新状态文本显示 |
| `start()` | 开始自动答题 |
| `stop()` | 停止自动答题 |
| `updateLogs()` | 更新日志显示（带颜色标记） |
| `clearLogs()` | 清空日志 |
| `copyLogs()` | 复制日志到剪贴板 |
| `fallbackCopyLogs(text)` | 复制文本的备用方法（兼容旧浏览器） |
| `escapeHtml(text)` | HTML转义函数 |
| `loadAIConfig()` | 从浏览器存储加载AI配置 |
| `saveAIConfig()` | 保存AI配置到浏览器存储 |
| `updateAIStatus()` | 更新AI状态显示 |
| `testAIConnection()` | 测试AI连接（发送测试请求） |

---

### 6. AI答题管理器 (aiAnswerManager)

| 函数名 | 用途 |
|--------|------|
| `callAI(question, baseUrl, apiKey, model, retryCount, skipRunningCheck)` | 调用AI API（支持流式响应、重试机制、频率限制） |
| `extractAnswerFromReasoning(reasoningContent)` | 从reasoning_content字段中提取答案（使用正则表达式） |
| `answerWithAI(questionText, options, questionType, questionId)` | 使用AI回答问题（构建提示词、调用API、解析答案） |

---

### 7. 分数分析器 (scoreAnalyzer)

| 函数名 | 用途 |
|--------|------|
| `analyzeScore(data)` | 分析答题结果，计算已确定和未确定的分数 |
| `updateScoreDisplay(scoreInfo, pageStatus)` | 更新控制面板中的分数显示（header和控制标签页） |
| `detectPageStatus(data)` | 检测页面答题状态（是否已完成、提交时间等） |
| `extractCorrectAnswers(data)` | 从答题结果中反向提取正确答案（correct === true的题目） |
| `analyzeFromPage()` | 从当前页面URL提取busyworkId并分析分数 |

---

### 8. 网络请求拦截器 (networkInterceptor)

| 函数名 | 用途 |
|--------|------|
| `init()` | 初始化网络请求拦截器（拦截fetch和XMLHttpRequest） |
| `isQuestionData(data)` | 检查数据是否是题目数据格式（支持多种格式） |
| `handleQuestionData(data, source)` | 处理题目数据（加载到答案库、初始化答题记录、AI分析） |

---

### 9. 全局函数

| 函数名 | 用途 |
|--------|------|
| `init()` | 脚本初始化函数（加载配置、启动脚本） |
| `startScript()` | 启动脚本（创建控制面板、启动拦截器、加载记录） |

---

## 主要功能特性

### 1. 自动答题
- 支持5种题目类型：单选题、多选题、判断题、填空题、简答题
- 自动从答案库匹配答案
- 支持跳过已答题或重新答题
- 自动提交功能（可选）

### 2. AI答题
- 支持OpenAI兼容的API（DeepSeek、ModelScope、OpenAI等）
- 流式响应支持
- 自动重试机制（HTTP 429错误）
- 频率限制和请求延迟
- 从reasoning_content提取答案

### 3. 答案库管理
- 支持多种JSON格式（index.json、fasfa.json）
- ID映射支持（questionId ↔ id）
- 题目内容去重
- 从答题结果反向提取正确答案
- 本地存储持久化

### 4. 答题记录
- 记录所有答题过程（题目、答案、时间）
- 支持导出（JSON、TXT、CSV）
- 支持导入答案
- 按时间排序（最新在前）

### 5. 分数分析
- 自动分析答题分数（已确定/未确定）
- 显示答题状态（已完成/进行中）
- 显示题目统计和试卷信息
- 从答题结果中提取正确答案

### 6. 网络拦截
- 自动拦截网络请求获取题库
- 支持fetch和XMLHttpRequest
- 自动识别题目数据格式
- 自动加载到答案库

### 7. 控制面板
- 三个标签页：控制、AI答题、答题记录
- 可拖拽移动
- 实时日志显示（带颜色标记）
- AI配置管理
- 分数统计显示

---

## 配置项说明

### 基础配置
- `autoAnswer`: 自动答题开关
- `answerDelay`: 答题延迟（毫秒）
- `showControlPanel`: 是否显示控制面板
- `autoSubmit`: 是否自动提交
- `skipAnsweredQuestions`: 是否跳过已答题

### AI配置
- `enabled`: AI是否启用
- `baseUrl`: API基础URL
- `apiKey`: API密钥
- `model`: 模型名称
- `temperature`: 温度参数
- `maxTokens`: 最大token数
- `stream`: 是否使用流式响应
- `topP`: Top-p采样参数
- `frequencyPenalty`: 频率惩罚
- `presencePenalty`: 存在惩罚
- `retryOn429`: 是否在429错误时重试
- `maxRetries`: 最大重试次数
- `retryDelay`: 重试延迟（毫秒）
- `requestDelay`: 请求延迟（毫秒）

---

## 数据格式

### 答案库格式
```javascript
{
  "questionId": {
    "type": "0",  // 题目类型：0=单选，1=多选，2=判断，3=填空，4=简答
    "answer": "A",  // 答案
    "solution": "...",  // 解析
    "questionContent": "...",  // 题目内容
    "questionId": "...",  // 题目ID
    "source": "..."  // 来源
  }
}
```

### 答题记录格式
```javascript
{
  "id": "...",
  "questionId": "...",
  "questionContent": "...",
  "answer": "...",
  "questionType": "0",
  "timestamp": 1234567890
}
```

---

## 使用流程

1. **加载脚本**: 脚本自动加载，初始化配置和答案库
2. **拦截网络请求**: 自动拦截并加载题目数据到答案库
3. **开始答题**: 点击"开始自动答题"按钮
4. **自动答题**: 脚本遍历所有题目，从答案库匹配答案或使用AI答题
5. **记录过程**: 所有答题过程被记录到答题记录中
6. **分析分数**: 答题完成后自动分析分数并显示
7. **提取答案**: 从答题结果中提取正确答案，完善答案库

---

## 注意事项

1. 需要配置AI API才能使用AI答题功能
2. 答案库需要提前准备或通过答题结果自动提取
3. 简答题使用富文本编辑器，需要特殊处理
4. 网络拦截器会自动获取题目数据，无需手动导入
5. 所有配置和答案库都保存在浏览器本地存储中


