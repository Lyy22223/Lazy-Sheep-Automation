# 重构项目开发计划

## 项目概述

**项目名称**: 懒羊羊自动化平台 - 重构版  
**目标**: 基于多平台适配器架构重构现有脚本，提升性能、可维护性和可扩展性  
**预期周期**: 4-6周  
**当前版本**: 2.0.0-alpha.1

---

## 阶段划分

### 第一阶段: 基础架构搭建 (Week 1)

**目标**: 完成核心模块和基础架构

#### Week 1.1: 核心工具库 (2-3天)

**任务清单**:
- [x] 创建项目目录结构
- [x] 编写 package.json
- [x] 编写架构文档
- [ ] 实现核心工具模块
  - [ ] `core/config.js` - 配置管理
  - [ ] `core/constants.js` - 常量定义
  - [ ] `core/dom-cache.js` - DOM缓存管理器
  - [ ] `core/vue-utils.js` - Vue工具库
  - [ ] `core/utils.js` - 通用工具函数
- [ ] 编写单元测试
  - [ ] 测试 DOMCache
  - [ ] 测试 VueUtils
  - [ ] 测试工具函数

**验收标准**:
- ✅ 所有核心工具函数都有单元测试
- ✅ 测试覆盖率 > 80%
- ✅ 通过 ESLint 检查

#### Week 1.2: 平台适配器基础 (2-3天)

**任务清单**:
- [ ] 实现平台适配器基类
  - [ ] `platforms/base.js` - PlatformAdapter 基类
  - [ ] `platforms/manager.js` - PlatformManager
- [ ] 实现传智播客适配器
  - [ ] `platforms/czbk/selectors.js` - 选择器定义
  - [ ] `platforms/czbk/extractor.js` - 数据提取器
  - [ ] `platforms/czbk/adapter.js` - 完整适配器
- [ ] 编写适配器测试
  - [ ] 测试平台检测
  - [ ] 测试数据提取
  - [ ] 测试DOM选择器

**验收标准**:
- ✅ 平台管理器能正确检测传智播客平台
- ✅ 能正确提取所有题型的题目数据
- ✅ 选择器定义完整准确

#### Week 1.3: 构建配置 (1-2天)

**任务清单**:
- [ ] 配置 Webpack
  - [ ] `config/webpack.config.js`
  - [ ] 支持开发和生产模式
  - [ ] 配置 Babel 转译
- [ ] 配置测试环境
  - [ ] `config/jest.config.js`
  - [ ] 配置 JSDOM 环境
- [ ] 编写构建脚本
  - [ ] `config/build-userscript.js` - 生成油猴脚本

**验收标准**:
- ✅ `npm run build` 能正常构建
- ✅ `npm test` 能运行所有测试
- ✅ 能生成符合油猴规范的脚本

---

### 第二阶段: 核心功能实现 (Week 2-3)

**目标**: 实现答题相关的核心功能

#### Week 2.1: 答案模块 (3-4天)

**任务清单**:
- [ ] 实现答案查询模块
  - [ ] `modules/answer-query.js`
  - [ ] 云端API查询
  - [ ] AI答题集成
  - [ ] 本地缓存(可选)
- [ ] 实现答案填充模块
  - [ ] `modules/answer-filler.js`
  - [ ] 单选题填充
  - [ ] 多选题填充 (修复 stuAnswer 格式)
  - [ ] 判断题填充
  - [ ] 填空题填充
  - [ ] 简答题填充
- [ ] 编写测试
  - [ ] 模拟API响应
  - [ ] 测试所有题型填充

**关键注意事项**:
- 多选题 `stuAnswer` 必须是字符串格式 "012"
- 需要触发 Vue 的响应式更新
- 需要触发平台的自动保存事件

**验收标准**:
- ✅ 所有题型填充正确
- ✅ Vue数据同步正确
- ✅ 平台能自动保存答案

#### Week 2.2: 自动答题 (2-3天)

**任务清单**:
- [ ] 实现自动答题模块
  - [ ] `modules/auto-answer.js`
  - [ ] 批量处理题目
  - [ ] 答题进度显示
  - [ ] 错误处理和重试
- [ ] 实现提交处理
  - [ ] `modules/submit-handler.js`
  - [ ] 处理提交确认对话框
  - [ ] 区分作业和考试
  - [ ] 提交成功检测
- [ ] 实现作业列表处理
  - [ ] `modules/busywork-list.js`
  - [ ] 检测作业列表页面
  - [ ] 提取作业列表
  - [ ] 自动开始作业

**验收标准**:
- ✅ 能自动答完所有题目
- ✅ 能自动处理提交对话框
- ✅ 能从作业列表自动开始

#### Week 2.3: 网络模块 (2-3天)

**任务清单**:
- [ ] 实现API客户端
  - [ ] `network/api-client.js`
  - [ ] 统一的请求接口
  - [ ] 错误处理
  - [ ] 超时重试
- [ ] 实现请求队列
  - [ ] `network/request-queue.js`
  - [ ] 请求去重
  - [ ] 并发控制
  - [ ] 批量请求优化
- [ ] 实现网络拦截器
  - [ ] `network/interceptor.js`
  - [ ] 拦截批改结果
  - [ ] 提取题目数据

**验收标准**:
- ✅ 请求去重正常工作
- ✅ 批量请求性能提升明显
- ✅ 网络错误能正确处理

---

### 第三阶段: 高级功能 (Week 3-4)

**目标**: 实现智能纠错和UI优化

#### Week 3.1: 智能纠错 (3-4天)

**任务清单**:
- [ ] 实现纠错模块
  - [ ] `network/correction.js`
  - [ ] 检测错题
  - [ ] 策略选择器
  - [ ] 排除法纠错 (单选)
  - [ ] AI辅助纠错 (多选/填空/简答)
  - [ ] 判断题切换
- [ ] 优化纠错策略
  - [ ] 基于题型选择最优策略
  - [ ] 减少AI消耗
  - [ ] 提高纠错成功率
- [ ] 编写纠错测试

**验收标准**:
- ✅ 纠错成功率 > 80%
- ✅ AI消耗降低 40%
- ✅ 能自动完成多轮纠错

#### Week 3.2: UI模块 (2-3天)

**任务清单**:
- [ ] 实现控制面板
  - [ ] `ui/panel.js`
  - [ ] 使用 Vue 3 + Element Plus
  - [ ] 配置管理界面
  - [ ] 答题日志显示
  - [ ] 统计信息展示
- [ ] 实现结果展示
  - [ ] `ui/result-display.js`
  - [ ] 答题结果弹窗
  - [ ] 错题列表
- [ ] 编写样式
  - [ ] `ui/styles.js`
  - [ ] 响应式设计

**验收标准**:
- ✅ UI美观易用
- ✅ 支持移动端
- ✅ 配置能正确保存

#### Week 3.3: 防作弊绕过 (1-2天)

**任务清单**:
- [ ] 实现防作弊绕过
  - [ ] `modules/anti-cheat-bypass.js`
  - [ ] 移除窗口切换检测
  - [ ] 移除页面可见性检测
  - [ ] 解除键盘锁定
  - [ ] 允许右键和复制
- [ ] 提供配置开关

**验收标准**:
- ✅ 切换标签页无警告
- ✅ 可以使用右键菜单
- ✅ 可以复制题目内容

---

### 第四阶段: 多平台扩展 (Week 4-5)

**目标**: 添加第二个平台支持

#### Week 4.1: 超星学习通适配器 (3-5天)

**任务清单**:
- [ ] 研究超星学习通平台
  - [ ] 分析页面结构
  - [ ] 提取DOM选择器
  - [ ] 分析API接口
  - [ ] 分析题型格式
- [ ] 实现适配器
  - [ ] `platforms/chaoxing/selectors.js`
  - [ ] `platforms/chaoxing/extractor.js`
  - [ ] `platforms/chaoxing/adapter.js`
- [ ] 注册到平台管理器
- [ ] 编写测试

**验收标准**:
- ✅ 能正确检测超星学习通平台
- ✅ 能提取题目数据
- ✅ 能填充答案

#### Week 4.2: 多平台测试 (2-3天)

**任务清单**:
- [ ] 编写跨平台测试
- [ ] 测试平台切换
- [ ] 测试数据隔离
- [ ] 性能测试

**验收标准**:
- ✅ 两个平台都能正常工作
- ✅ 平台切换无冲突
- ✅ 性能符合预期

---

### 第五阶段: 测试与优化 (Week 5-6)

**目标**: 完善测试和优化性能

#### Week 5.1: 测试完善 (3-4天)

**任务清单**:
- [ ] 完善单元测试
  - [ ] 所有模块 100% 覆盖
  - [ ] 边界条件测试
  - [ ] 异常情况测试
- [ ] 编写集成测试
  - [ ] 完整答题流程
  - [ ] 纠错流程
  - [ ] 多平台切换
- [ ] 编写E2E测试(可选)
  - [ ] 使用 Puppeteer
  - [ ] 模拟真实用户操作

**验收标准**:
- ✅ 单元测试覆盖率 > 90%
- ✅ 集成测试通过
- ✅ 无严重BUG

#### Week 5.2: 性能优化 (2-3天)

**任务清单**:
- [ ] 性能基准测试
  - [ ] DOM查询性能
  - [ ] Vue更新性能
  - [ ] 答题速度
- [ ] 优化瓶颈
  - [ ] 减少DOM查询
  - [ ] 优化缓存策略
  - [ ] 减少重绘重排
- [ ] 内存优化
  - [ ] 避免内存泄漏
  - [ ] 及时清理缓存

**验收标准**:
- ✅ DOM查询速度提升 40-60%
- ✅ 答题速度提升 30-40%
- ✅ 内存占用合理

#### Week 5.3: 文档完善 (2-3天)

**任务清单**:
- [ ] 完善开发文档
  - [x] 架构设计文档
  - [x] 迁移指南
  - [ ] API文档
  - [ ] 贡献指南
- [ ] 编写用户文档
  - [ ] 使用手册
  - [ ] 常见问题
  - [ ] 配置说明
- [ ] 代码注释
  - [ ] JSDoc 注释
  - [ ] 复杂逻辑说明

**验收标准**:
- ✅ 文档完整清晰
- ✅ 新开发者能快速上手
- ✅ 用户能独立使用

---

### 第六阶段: 发布准备 (Week 6)

**目标**: 准备发布和部署

#### Week 6.1: 灰度发布 (3-4天)

**任务清单**:
- [ ] 准备发布版本
  - [ ] 更新版本号
  - [ ] 生成 CHANGELOG
  - [ ] 构建生产版本
- [ ] 灰度测试
  - [ ] 内部测试 (1-2天)
  - [ ] 小范围用户测试 (2-3天)
  - [ ] 收集反馈
- [ ] 修复问题

**验收标准**:
- ✅ 无严重BUG
- ✅ 用户反馈良好
- ✅ 性能达标

#### Week 6.2: 正式发布 (1-2天)

**任务清单**:
- [ ] 发布到 GreasyFork
- [ ] 发布到 GitHub
- [ ] 编写发布说明
- [ ] 通知用户升级

**验收标准**:
- ✅ 发布成功
- ✅ 文档完善
- ✅ 用户能顺利升级

---

## 技术要点

### 关键技术决策

1. **DOM缓存**: 使用 Map + TTL,5秒缓存
2. **Vue操作**: 支持 Vue 2/3,多级实例查找
3. **多选题格式**: stuAnswer 使用字符串 "012"
4. **平台检测**: 基于 hostname 和 DOM 特征
5. **请求优化**: 去重 + 批量 + 并发控制

### 需从旧版本迁移的信息

**从 `scripts/czbk_complete.user.js` 提取**:
- ✅ 配置参数 (config)
- ✅ 正则表达式 (REGEX_PATTERNS)
- ✅ API端点定义
- ✅ 答案填充逻辑
- ✅ 网络拦截逻辑
- ✅ 智能纠错算法

**从 `docs/app.js作业功能总结.md` 提取**:
- ✅ DOM选择器
- ✅ 题型ID定义
- ✅ API接口列表
- ✅ 数据结构定义
- ✅ 平台特性说明

**从 `backend/` 提取**:
- ⏸️ 后端API设计 (保持兼容)
- ⏸️ 数据库结构 (无需修改)

---

## 风险与应对

### 主要风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| 平台DOM变化 | 高 | 中 | 使用多个备用选择器 |
| Vue版本兼容 | 中 | 低 | 同时支持 Vue 2/3 |
| 开发周期延长 | 中 | 中 | 分阶段发布,MVP优先 |
| 性能不达标 | 中 | 低 | 持续性能测试和优化 |
| 用户迁移困难 | 低 | 中 | 详细迁移指南 + 自动迁移 |

### 应对策略

1. **MVP策略**: 先完成传智播客平台,再扩展其他平台
2. **灰度发布**: 小范围测试,逐步推广
3. **版本兼容**: 保持与旧版本并行运行一段时间
4. **持续集成**: 每次提交都运行测试
5. **用户反馈**: 建立反馈渠道,快速响应

---

## 资源分配

### 人力资源

- **开发**: 1人全职 (你)
- **测试**: 可选,内部测试
- **文档**: 开发人员兼职

### 时间分配

- **编码**: 60% (24天)
- **测试**: 20% (8天)
- **文档**: 10% (4天)
- **其他**: 10% (4天)

### 工具资源

- **开发工具**: VSCode + ESLint + Prettier
- **测试工具**: Jest + JSDOM
- **构建工具**: Webpack
- **版本控制**: Git + GitHub

---

## 里程碑

### M1: 基础架构完成 (Week 1 结束)
- ✅ 核心工具库
- ✅ 平台适配器基础
- ✅ 构建配置

### M2: 核心功能完成 (Week 3 结束)
- ✅ 答案查询和填充
- ✅ 自动答题
- ✅ 网络模块
- ✅ 智能纠错

### M3: 多平台支持 (Week 5 结束)
- ✅ 超星学习通适配器
- ✅ 跨平台测试

### M4: 正式发布 (Week 6 结束)
- ✅ 测试完善
- ✅ 文档完善
- ✅ 灰度发布
- ✅ 正式发布

---

## 成功标准

### 功能完整性
- ✅ 支持传智播客所有功能
- ✅ 支持至少2个平台
- ✅ 智能纠错可用

### 性能指标
- ✅ DOM查询速度提升 40-60%
- ✅ 答题速度提升 30-40%
- ✅ 内存占用 < 100MB

### 质量指标
- ✅ 测试覆盖率 > 90%
- ✅ 无严重BUG
- ✅ 代码通过 ESLint

### 用户指标
- ✅ 迁移成功率 > 95%
- ✅ 用户满意度 > 85%
- ✅ BUG反馈 < 5个/周

---

## 下一步行动

### 立即开始 (Day 1-3)

1. **创建核心工具库**
   - [ ] `core/config.js`
   - [ ] `core/constants.js`
   - [ ] `core/dom-cache.js`
   - [ ] `core/vue-utils.js`
   - [ ] `core/utils.js`

2. **编写基础测试**
   - [ ] 配置 Jest
   - [ ] 编写第一个测试

3. **配置构建工具**
   - [ ] Webpack 配置
   - [ ] Babel 配置

### 本周目标 (Week 1)

完成基础架构搭建,能运行第一个测试,能构建出可用的脚本文件。

---

**文档版本**: 1.0  
**创建时间**: 2025-11-30  
**负责人**: Lyy  
**状态**: 进行中
