# 版本更新清单

## [未发布] - 2025-01-XX

### 功能改进
- 🔧 **所有题型填充功能优化**：简化并优化所有题型的填充方法
  - **简答题**：直接设置iframe body内容，不需要转换换行符，添加填充成功验证
  - **单选题**：简化点击逻辑，减少重复操作，保留核心Vue数据更新
  - **多选题**：简化checkbox点击逻辑，直接点击即可选中
  - **判断题**：简化点击逻辑，与单选题保持一致
  - **填空题**：优化延迟时间（200ms），添加填充结果验证
- 🔧 **智能纠错功能独立控制**：智能纠错功能独立于自动答题
  - 智能纠错只受"智能纠错"开关控制，不受"自动答题"影响
  - 修正开关检查逻辑，必须明确为 `true` 才启用
  - 智能纠错默认关闭，需要手动开启
  - 停止答题时不影响智能纠错运行状态
- 🔧 **前端缓存与后端AI协作优化**：实现方案A，前端缓存传递已尝试答案给后端AI
  - 前端在调用AI时传递已尝试的错误答案列表
  - 后端AI提示词简单优化，避免生成已尝试的错误答案
  - 前端缓存生命周期为1天，自动清理过期数据
  - 不在后端存储全局错误答案库，只记录人工提交的错误反馈
- ✨ **自动批量纠错功能**：检测到错误答案后自动批量纠错
  - 检测到错误答案后，自动上传批改结果到后端（后端尝试纠错）
  - 前端主动批量调用AI答题接口尝试纠错（每道题最多尝试3次）
  - 纠错完成后主动拉取批改结果，检查纠错效果
  - 自动上传正确答案到后端，清除缓存
- 🔧 **填空题答案处理优化**：去除填空题答案中的中文大括号【】
  - 在答案规范化时自动去除【】符号
  - 在错误答案缓存时也去除【】符号，确保格式统一

### 性能优化
- ✨ **批量检查优化上传**：大幅减少上传数据量，提升上传效率
  - 上传前批量检查后端是否已有答案（使用 `/api/search/batch` 接口）
  - 只上传后端没有的题目（新题目或错误答案需要纠错）
  - 如果所有题目后端都有正确答案，完全跳过上传
  - **预期效果**：减少 80-90% 的数据传输，显著提升上传速度
- ✨ **错误反馈记录系统**：记录所有题目的对错情况，便于人工检索
  - 自动记录每道题目的学生答案和正确答案
  - 按日期分组存储，支持日期筛选
  - 只显示错误答案反馈，方便人工检查
  - 支持导出JSON格式，便于后续分析
  - 提供错误反馈tab页，实时查看错误记录

### 功能改进
- 🔧 **移除手动上传功能**：统一使用自动上传机制，简化操作
  - 所有上传都是被动进行的（检测到批改结果后自动上传）
  - 上传前自动进行批量检查，避免重复上传
  - 如果后端已有正确答案，自动跳过上传

### 架构优化
- 🔧 **移除前端缓存**：前端不再进行答案本地缓存，统一由后端管理
  - 禁用 `answerDBManager` 的保存功能
  - 移除前端答案缓存逻辑，确保数据准确性和一致性
- 🔧 **智能纠错架构升级**：基于API的智能纠错系统
  - 前后端配合：前端负责API调用和答案修改，后端负责答案库查询和AI搜索
  - 完全通过API实现，无需页面跳转和DOM操作，提高稳定性和执行速度
  - 答案库集中管理，自动积累正确答案，越用越准确
  - 支持批量处理，可并发修改多个答案，效率高

### Bug修复
- 🐛 **修复定时任务日期计算错误**：修复月末日期计算导致的 `ValueError`（11月30日无法计算31日）
  - 使用 `timedelta(days=1)` 替代 `replace(day=day+1)`，正确处理月末和跨月情况
- 🐛 **修复Vue面板创建失败**：修复 `el-button` 的 `:icon` 属性使用特殊字符导致的 `createElement` 错误
  - 移除 `:icon` 属性，将箭头符号直接显示在按钮文本中
- 🐛 **修复多选题填充错误**：修复 `stuAnswer.split is not a function` 错误
  - 确保 `stuAnswer` 始终是字符串类型，避免页面代码调用 `split()` 时出错
  - 添加类型检查和 Vue 响应式更新支持
- 🔧 **优化智能纠错触发时机**：改进 `res.json` 格式识别逻辑
  - 支持保存操作（`updateStudentAns`）返回的批改结果，即使 `code` 和 `errorMessage` 为 `null`
  - 通过检查 `resultObject` 中的 `correct` 字段来判断是否为批改结果
  - 确保保存后能正确触发智能纠错

### 新增功能
- ✨ **智能纠错功能（基于API）**：完全通过API实现自动纠错，无需页面操作
  - **核心流程**：
    1. 获取题目和批改结果（`startBusywork` 未提交作业 / `、` 已提交作业）
    2. 上传题目到后端更新题库
    3. 提取错题（`correct: false`）
    4. 对每道错题：
       - 优先查询后端数据库获取答案
       - 数据库无答案时：
         * 单选题/判断题：排除法（依次尝试选项，最多尝试选项数-1次）
         * 多选题/填空题/简答题：AI搜索生成正确答案
    5. 通过API直接修改答案（`updateStudentAns`）
    6. 重新获取批改结果验证
    7. 答对后保存正确答案到数据库
  
  - **支持题型及策略**：
    - **单选题（type="0"）**：排除法，从索引0开始依次尝试（A→B→C→D），最多尝试（选项数-1）次
      - 答案格式：索引（`answer=1` 表示选项B）
      - 数据库存储：索引格式（0,1,2,3）
    - **多选题（type="1"）**：AI搜索正确答案（不采用排除法，组合太多）
      - 答案格式：索引，逗号分隔（`answer=0,1,2`）
      - AI返回字母格式（A,B）后转换为索引格式
    - **判断题（type="2"）**：排除法，先尝试"对"，错了就试"错"（最多2次）
      - 答案格式：中文URL编码（`answer=%E5%AF%B9` 表示"对"）
    - **填空题（type="3"）**：AI生成答案，最多尝试3次
      - 答案格式：JSON数组URL编码（`answer=%5B%22...%22%5D`）
      - 自动清理格式（去除【】、括号等特殊符号）
    - **简答题（type="4"）**：AI生成答案，最多尝试3次
      - 答案格式：HTML文本URL编码
  
  - **答案格式转换**：
    - 数据库统一存储索引格式（0,1,2,3），便于API直接使用
    - AI返回字母格式（A,B,C,D），后端自动转换为索引格式
    - 判断题和填空题/简答题需要URL编码
    - 自动处理答案格式转换，无需手动处理
  
  - **优势**：
    - ✅ 完全通过API实现，无需页面跳转和DOM操作
    - ✅ 批量处理错题，效率高
    - ✅ 答案库自动积累，越用越准确
    - ✅ 智能排除法，最多尝试几次即可找到正确答案
    - ✅ 支持前端提示：显示纠错进度和剩余尝试次数

### 后端改进
- 🔧 **Docker部署支持**：完整的Docker和Docker Compose配置
  - `backend/Dockerfile` - Docker镜像构建文件
  - `docker-compose.yml` - Docker Compose配置
  - `DOCKER_DEPLOY.md` - Docker部署文档
  - 支持资源限制配置（适合1核1GB服务器）
  - 数据持久化支持

- 🔧 **性能优化**：
  - 添加Gunicorn + Uvicorn Workers支持
  - 创建性能分析文档 `backend/PERFORMANCE_ANALYSIS.md`
  - 1核1GB服务器支持50-80并发用户

- 🔧 **代码优化**：
  - 添加UTF-8编码处理（避免乱码）
  - 添加logging日志记录
  - 完善DeepSeek模型注释说明

### 前端改进
- 🔧 **智能纠错前端实现（基于API）**：
  - **API调用封装**：
    - `startBusywork(busyworkId)` - 获取未提交作业的题目数据（包含批改结果）
    - `findStudentBusywork(busyworkId)` - 获取已提交作业的批改结果
    - `updateStudentAns(busyworkId, questionId, answer)` - 直接修改答案（无需保存操作）
    - 支持自动判断作业状态（未提交/已提交）
  
  - **答案格式转换**：
    - 单选题：字母格式（A,B,C）↔ 索引格式（0,1,2）
    - 多选题：字母格式（A,B）↔ 索引格式（0,1）
    - 判断题：中文格式（"对"/"错"）自动URL编码
    - 填空题：字符串格式 ↔ JSON数组格式，自动URL编码
    - 简答题：HTML文本自动URL编码
  
  - **排除法实现**：
    - 单选题：从索引0开始依次尝试，记录已尝试答案，避免重复
    - 判断题：先尝试"对"，错了就试"错"
    - 自动计算剩余尝试次数并提示用户
  
  - **AI搜索集成**：
    - 多选题/填空题/简答题：调用后端AI搜索接口
    - AI返回字母格式后自动转换为API需要的索引格式
    - 支持AI修正（告诉AI之前的答案不对，重新生成）
  
  - **错误处理和重试**：
    - 网络请求失败自动重试（最多3次，指数退避）
    - 批改结果获取失败自动重试
    - 智能延迟：根据题目类型调整等待时间（单选/判断1秒，多选/填空2秒）
  
  - **用户体验**：
    - 显示纠错进度（如：正在纠错 3/10）
    - 提示剩余尝试次数（如：最多还需尝试2次）
    - 答对后自动保存到数据库，下次直接使用

### 项目整理
- 🗑️ **清理不相关文件**：
  - 移除测试文件（`test_*.py`）
  - 移除工具脚本（`get_api_key.py`等）
  - 移除测试数据文件（`data/*.json`）
  - 更新`.gitignore`排除规则

### 文档
- 📝 添加Docker部署文档
- 📝 添加性能分析文档
- 📝 更新README

---

## [4.0.0] - 2025-01-XX

### 主要功能
- Vue3 + ElementPlus现代化UI
- 网络请求拦截器（自动捕获题目数据）
- AI答题功能（支持DeepSeek和OpenAI）
- 云端答案库同步
- 本地答案库管理

---

## 版本号说明

格式：`主版本号.次版本号.修订号`

- **主版本号**：不兼容的API修改
- **次版本号**：向下兼容的功能性新增
- **修订号**：向下兼容的问题修正

